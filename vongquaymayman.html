<!doctype html>
<html lang="vi">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Vòng quay may mắn</title>
	<style>
		:root{--size:520px}
		body{font-family:system-ui,-apple-system,Segoe UI,Roboto, "Helvetica Neue", Arial;margin:0;min-height:100vh;display:grid;place-items:center;background:#0f172a;color:#fff}
		.container{width:100%;max-width:980px;padding:24px;box-sizing:border-box}
		.card{background:linear-gradient(180deg,#071133 0%, #0b1b3d 100%);border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,.6)}
		.header{display:flex;align-items:center;justify-content:center;margin-bottom:12px}
		h1{font-size:20px;margin:0}
		.wheel-wrap{display:flex;gap:20px;align-items:center;flex-wrap:wrap}
		.wheel{width:var(--size);height:var(--size);border-radius:50%;position:relative;overflow:visible;margin:0 auto;display:grid;place-items:center}
		/* rotor rotates; pointer stays fixed */
		.rotor{width:100%;height:100%;border-radius:50%;transform-origin:50% 50%;transition:transform 0.4s linear}
		.wheel svg{width:100%;height:100%;display:block}
		.pointer{position:absolute;left:50%;top:6px;transform:translateX(-50%);width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,#fff,#ffd24d);display:grid;place-items:center;color:#111;font-weight:900;z-index:60;box-shadow:0 6px 18px rgba(0,0,0,.45)}
		.pointer:after{content:'▲';transform:translateY(-6px);font-size:22px}
		.spin-btn{display:block;margin:10px auto 0;padding:12px 18px;border-radius:10px;border:none;background:linear-gradient(90deg,#ffb347,#ffcc33);color:#222;font-weight:700;cursor:pointer;font-size:16px}
		.legend{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:12px}
		.chip{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.03);padding:6px 10px;border-radius:999px}
		.chip span{font-weight:700}
		/* modal */
		.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.7);display:none;align-items:center;justify-content:center;z-index:200}
		.modal{background:linear-gradient(180deg,#fff,#f3f4f6);color:#111;padding:24px;border-radius:12px;min-width:300px;max-width:90%;text-align:center}
		.modal h2{margin:0 0 8px}
		.close-btn{margin-top:12px;padding:8px 12px;border-radius:8px;border:none;background:#0b69ff;color:#fff;cursor:pointer}
		/* confetti canvas */
		canvas.confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:150;display:none}
		/* small screens */
		@media (max-width:640px){:root{--size:360px}}
	</style>
</head>
<body>
	<div class="container">
		<div class="card">
			<div class="header">
				<h1 style="font-size: 50px;">Vòng quay may mắn</h1>
			</div>

			<div class="wheel-wrap">
				<div style="flex:1;min-width:300px">
					<div class="wheel" id="wheel">
						<div class="pointer" aria-hidden title="Mũi tên cố định"></div>
						<div class="rotor" id="rotor">
							<!-- SVG wheel generated by JS -->
							<svg viewBox="0 0 1000 1000" id="wheelSvg" role="img" aria-label="Vòng quay">
								<!-- sectors will be injected -->
							</svg>
							<!-- center knob -->
							<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:86px;height:86px;background:radial-gradient(circle,#fff,#ffd24d);border-radius:50%;display:grid;place-items:center;font-weight:800;color:#111;box-shadow:0 6px 20px rgba(0,0,0,.45)">Go</div>
						</div>
					</div>
					<button id="spin" class="spin-btn">Quay</button>
					<div class="legend" aria-hidden>
						<div class="chip"> <strong>Hiển thị</strong> </div>
						<div class="chip"> <span>10.000</span> </div>
						<div class="chip"> <span>20.000</span> </div>
						<div class="chip"> <span>50.000</span> </div>
						<div class="chip"> <span>100.000</span> </div>
						<div class="chip"> <span>200.000</span> </div>
						<div class="chip"> <span>500.000</span> </div>
					</div>
				</div>

				<div style="width:320px;min-width:240px;display:flex;flex-direction:column;gap:10px;align-items:center">
					<div style="background:rgba(255,255,255,.03);padding:14px;border-radius:10px;text-align:center;width:100%">
						<div style="font-size:13px;opacity:.8">Số tiền vừa quay</div>
						<div id="currentPrize" style="font-size:28px;font-weight:800;margin-top:6px">-</div>
					</div>
					<div style="background:linear-gradient(90deg,#062343,#0b1b3d);padding:14px;border-radius:10px;text-align:center;width:100%">
						<div style="font-size:13px;opacity:.8">Lưu ý</div>
						<div style="font-size:14px;margin-top:6px">Số tiền trúng thưởng sẽ được chuyển vào tài khoản người trúng sau giờ học nhaa!!!</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal-backdrop" id="modal">
		<div class="modal" role="dialog" aria-modal="true">
			<h2 id="modalTitle">Chúc mừng!</h2>
			<p id="modalText" style="font-size:20px;margin:8px 0;font-weight:700">Bạn nhận được <span id="modalPrize" style="color: red;">0</span></p>
			<button class="close-btn" id="closeModal">Đóng</button>
		</div>
	</div>

	<canvas class="confetti" id="confetti"></canvas>

	<script>
		// Data and config
		const sectors = [20000,100000,50000,200000,500000,100000,10000,500000,200000];
		// We'll duplicate or reorder to make full ring of 8; sectors array length = 8
		const allowedWins = new Set([10000,20000,50000]);

		// Configuration: set weights (percent) for each winning group.
		// Edit these numbers in the code to tune probabilities. They don't need to sum to 100; values will be normalized.
		const config = {  // tỉ lệ xuất hiện mệnh giá tiền
			weights: {
				10000: 45, // default 60% chance for 10k
				20000: 30, // default 30% for 20k
				50000: 25  // default 10% for 50k
			}
		};

		const svg = document.getElementById('wheelSvg');
		const size = 1000;
		const cx = size/2, cy = size/2, r = size/2 - 6;

		// vibrant colors for display
		const colors = ['#ff4d6d','#ff7a59','#ffc857','#7bd389','#4cc9f0','#845ec2','#ff6f91','#ff9671'];

		function drawWheel(){
			svg.innerHTML = '';
			const n = sectors.length;
			const anglePer = 360 / n;
			for(let i=0;i<n;i++){
				const start = (i*anglePer) * Math.PI/180;
				const end = ((i+1)*anglePer) * Math.PI/180;
				const x1 = cx + r * Math.cos(start);
				const y1 = cy + r * Math.sin(start);
				const x2 = cx + r * Math.cos(end);
				const y2 = cy + r * Math.sin(end);
				const path = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2} Z`;
				const g = document.createElementNS('http://www.w3.org/2000/svg','path');
				g.setAttribute('d',path);
				g.setAttribute('fill', colors[i % colors.length]);
				g.setAttribute('stroke','rgba(0,0,0,0.15)');
				g.setAttribute('stroke-width','2');
				svg.appendChild(g);

				// label with rotation so text appears radial and readable
				const midAngle = ((i + 0.5) * anglePer);
				const rad = midAngle * Math.PI/180;
				const lx = cx + (r*0.64) * Math.cos(rad);
				const ly = cy + (r*0.64) * Math.sin(rad);
				const text = document.createElementNS('http://www.w3.org/2000/svg','text');
				text.setAttribute('x', lx);
				text.setAttribute('y', ly);
				text.setAttribute('fill','#04101a');
				text.setAttribute('font-size','42');
				text.setAttribute('font-weight','800');
				text.setAttribute('text-anchor','middle');
				text.setAttribute('dominant-baseline','middle');
				const rotate = `rotate(${midAngle}, ${lx}, ${ly})`;
				text.setAttribute('transform', rotate);
				text.textContent = (sectors[i] >= 1000) ? (sectors[i]/1000) + 'k' : sectors[i];
				svg.appendChild(text);
			}
		}

		drawWheel();

		// Spin logic: choose only from allowed sectors
		const spinBtn = document.getElementById('spin');
		const wheelEl = document.getElementById('wheel');
		const prizeDisplay = document.getElementById('currentPrize');
		const modal = document.getElementById('modal');
		const modalPrize = document.getElementById('modalPrize');
		const modalTitle = document.getElementById('modalTitle');
		const closeModal = document.getElementById('closeModal');
		const confettiCanvas = document.getElementById('confetti');

		let spinning = false;

		// Utility to pick a random allowed sector index using weighted group probabilities from config
		function pickAllowedIndex(){
			// Group indices by value (e.g., 10000 -> [i,i2])
			const groups = {};
			sectors.forEach((v,i)=>{
				if(!allowedWins.has(v)) return; // only group allowed winning values
				if(!groups[v]) groups[v] = [];
				groups[v].push(i);
			});

			// Build weighted array
			const entries = Object.keys(groups).map(k=>({
				value: Number(k),
				indices: groups[k],
				weight: (config.weights[k] != null) ? Number(config.weights[k]) : 0
			})).filter(e=>e.weight > 0 && e.indices.length>0);

			if(entries.length === 0){
				// fallback: uniform among allowed indices
				const allowedIndices = sectors.map((v,i)=> allowedWins.has(v) ? i : -1).filter(i=>i>=0);
				return allowedIndices[Math.floor(Math.random()*allowedIndices.length)];
			}

			// normalize weights
			const total = entries.reduce((s,e)=>s+e.weight,0);
			let r = Math.random() * total;
			let chosenGroup = entries[0];
			for(const e of entries){
				if(r < e.weight){ chosenGroup = e; break; }
				r -= e.weight;
			}

			// pick random index inside chosen group
			const arr = chosenGroup.indices;
			return arr[Math.floor(Math.random()*arr.length)];
		}

		// compute rotation so that chosen index lands at pointer (top)
		function computeRotationForIndex(index){
			const n = sectors.length;
			const anglePer = 360/n;
			// sector i middle angle measured from +X axis (0deg at right). Pointer is at top (270deg from +X).
			const targetAngle = (index + 0.5) * anglePer; // degrees
			// We want targetAngle + rotation = 270 (top). So rotation = 270 - targetAngle (mod 360).
			const final = ((270 - targetAngle) % 360 + 360) % 360;
			return final;
		}

		function animateSpinTo(finalRotation, options={duration:14200}){
				return new Promise((resolve)=>{
					const rotor = document.getElementById('rotor');
					const start = performance.now();
					const from = getCurrentRotation(rotor) || 0;
					// add extra full rotations for effect (more since longer duration)
					const extra = 360 * (6 + Math.floor(Math.random()*8));
					const to = extra + finalRotation;
					function tick(now){
						const t = Math.min(1,(now-start)/options.duration);
						const eased = 1 - Math.pow(1-t,3); // ease-out cubic
						const cur = from + (to - from) * eased;
						rotor.style.transform = `rotate(${cur}deg)`;
						if(t < 1) requestAnimationFrame(tick);
						else resolve(cur % 360);
					}
					requestAnimationFrame(tick);
				});
		}

		function getCurrentRotation(el){
			const st = window.getComputedStyle(el).transform;
			if(st === 'none') return 0;
			const values = st.split('(')[1].split(')')[0].split(',');
			const a = parseFloat(values[0]);
			const b = parseFloat(values[1]);
			const angle = Math.round(Math.atan2(b,a) * (180/Math.PI));
			return angle;
		}

		// Confetti simple implementation
		function showConfetti(){
			const canvas = confettiCanvas;
			canvas.style.display = 'block';
			const ctx = canvas.getContext('2d');
			function resize(){canvas.width = innerWidth; canvas.height = innerHeight}
			resize(); window.addEventListener('resize', resize);
			const particles = [];
			const colors = ['#ff4d6d','#ff7a59','#ffc857','#7bd389','#4cc9f0','#845ec2','#ff6f91'];
			for(let i=0;i<160;i++){
				particles.push({
					x: Math.random()*canvas.width,
					y: -Math.random()*canvas.height,
					vx: (Math.random()-0.5)*6,
					vy: 2 + Math.random()*6,
					size: 6 + Math.random()*8,
					color: colors[Math.floor(Math.random()*colors.length)],
					drag: 0.99,
					rot: Math.random()*360,
					vro: (Math.random()-0.5)*10
				});
			}
			let raf;
			function frame(){
				ctx.clearRect(0,0,canvas.width,canvas.height);
				for(const p of particles){
					p.x += p.vx; p.y += p.vy; p.vx *= p.drag; p.vy += 0.15; p.rot += p.vro;
					ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
					ctx.fillStyle = p.color; ctx.fillRect(-p.size/2,-p.size/2,p.size, p.size*0.6);
					ctx.restore();
				}
				raf = requestAnimationFrame(frame);
			}
			frame();
			setTimeout(()=>{ cancelAnimationFrame(raf); ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display='none'; window.removeEventListener('resize', resize); }, 5200);
		}

		spinBtn.addEventListener('click', async ()=>{
			if(spinning) return;
			spinning = true; spinBtn.disabled = true; spinBtn.textContent = 'Đang quay...';

			const chosenIndex = pickAllowedIndex();
			const finalRotation = computeRotationForIndex(chosenIndex);
			const landedRotation = await animateSpinTo(finalRotation); // default longer duration

			// find landed index by mapping rotation to sector
			const n = sectors.length;
			const anglePer = 360/n;
			// rotation angle of rotor (degrees). Determine which sector's midAngle is at top (270deg from +X).
			const rot = (landedRotation % 360 + 360) % 360; // 0..360
			// sector i's midAngle after rotation = (midAngle + rot) %360. We want midAngle+rot ~= 270
			const topAngle = ((270 - rot) % 360 + 360) % 360;
			const idx = Math.floor(topAngle / anglePer) % n;
			const prize = sectors[idx];

			// Update UI
			prizeDisplay.textContent = prize.toLocaleString('vi-VN') + ' đ';
			modalPrize.textContent = prize.toLocaleString('vi-VN') + ' đ';
			modalTitle.textContent = allowedWins.has(prize) ? 'Chúc mừng!' : 'Rất tiếc';

			// show confetti only if a win (allowed)
			if(allowedWins.has(prize)) showConfetti();
			modal.style.display = 'flex';

			spinBtn.disabled = false; spinBtn.textContent = 'Quay'; spinning = false;
		});

		closeModal.addEventListener('click', ()=>{ modal.style.display = 'none'; });

		// accessibility: allow Enter to spin
		spinBtn.addEventListener('keyup', (e)=>{ if(e.key==='Enter') spinBtn.click(); });

		// initial rotation styling for rotor
		document.getElementById('rotor').style.transition = 'transform 0.4s linear';

		// small note in comments
		/*
			Page behavior:
			- Wheel has sectors for values [10000,20000,50000,100000,200000,500000,10000,20000]
			- When user clicks "Quay", the code only selects among allowed sectors (10k/20k/50k)
			- The wheel animates to land on one of those sectors while other sectors are decorative
			- Confetti and modal shown for wins
		*/
	</script>
</body>
</html>
